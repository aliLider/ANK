    {% extends 'ru/base.html' %}

    {% load static %}

    {% block title %} Savat {% endblock title %}


    {% block content %}

    <style>
        .sklad{
            width: 80%;
            text-align: center;
            padding: 7px;
            height: 35px;
            margin-top: 40px;
            color: white;
            border: 0;
            border-radius: 10px;
            background-color: #2a8401;
            font-size: 16px;
            margin-bottom: 50px;
            margin-left: 10%;
        }
        .sklad:hover{
            background-color: #004b23;
        }
        .item{
            position: relative;
            display: flex;
            margin-top: 20px;
            border-radius: 20px;
            margin-left: 10%;
            width: 80%;
            height: 310px;
            border: 2px solid #000000;
        }
        .h3cha{
            color: #004b23;
            text-align: center;
        }
        .img_minus{
            position: absolute;
            bottom: 20px;
            right: 20px;
        }
        .item01 input{
            margin-left: 0px;
            margin-top: 30px;
            height: 40px;
            width: 300px;
            border-radius: 10px;
            border: 2px solid  black; font-size: 20px;
        }
        .item01 label{
            font-size: 27px;
            font-weight: bold;
            margin-left: 30px;
        }
        .item01 .h102{
            margin-top: 35px;
            margin-left: 30px;
        }
        .h101{
            margin-top: 55px;
            margin-left: 30px;
        }
        .imgcha{
            width: 250px;
            height: 250px;
            border-radius: 10px;
            margin-left: 30px;
            margin-top: 30px;
        }
        .message{
            font-size: 21px;
        }
    @media screen and (max-width: 1024px) and (min-width:769px){
        .item01 input{
            margin-top: 30px;
            height: 35px;
            width: 280px;
            font-size: 18px;
        }
        .item{
            margin-top: 20px;
            border-radius: 20px;
            margin-left: 5%;
            width: 90%; height: 290px;
            border: 2px solid black;
        }
        .item01 label{
            font-size: 24px;
            font-weight: bold;
            margin-left: 30px;

        }
        .item01 .h102{
            margin-top: 30px;
            margin-left: 30px;
            font-size: 24px;
        }
        .h101{
            margin-top: 55px;
            margin-left: 30px;
            font-size: 27px;
        }
        .imgcha{
            width: 230px;
            height: 230px;
        }
    }
    @media screen and (max-width: 768px) and (min-width:420px){
        .item{
            display: flex;
            flex-wrap: wrap;
            height: auto;
            padding-bottom:50px ;
            width: 90%;
            margin-left: 5%;
        }
        .img_minus{
            bottom: 5px;
            right: 5px;
        }
        .item01 input{
            margin-left: 0px;
            margin-top: 20px;
            height: 35px;
            width: 280px;
            border-radius: 10px;
            border: 2px solid  black;
            font-size: 20px;
        }
        .item01 label{
            font-size: 25px;
            font-weight: bold;
            margin-left: 30px;
        }
        .item01 .h102{
            margin-top: 18px;
            margin-left: 30px;
            font-size: 25px;
        }
        .h101{
            margin-top: 25px;
            margin-left: 30px;
            font-size: 25px;
        }
        .blog_teg{
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        .imgcha{
            margin: 0;
            padding: 0;
            margin-top: 10px;
            width: 300px;
        }

    }
    @media screen and (max-width: 420px) and (min-width:100px){
        .item{
            display: flex;
            flex-wrap: wrap;
            height: auto;
            padding-bottom:50px ;
            width: 92%;
            margin-left: 3%;
        }
        .img_minus{
            bottom: 5px;
            right: 5px;
        }
        .item01 input{
            margin-left: 0px;
            margin-top: 20px;
            border-radius: 10px;
            border: 2px solid  black;
            font-size: 18px;
        }
        .item01 label{
            font-size: 25px;
            font-weight: bold;
            margin-left: 10px;
        }
        .item01 .h102{
            margin-top: 16px;
            margin-left: 10px;
            font-size: 22px;
        }
        .h101{
            margin-top: 20px;
            margin-left: 10px;
            font-size: 22px;
            text-align: center;
        }
        .blog_teg{
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }
        .imgcha{
            margin: 0;
            margin-top: 10px;
        }
        .h3cha{
            font-size: 17px;
        }
    }
    #total_2{
        margin: 10px 0 0 30px;
    }
    #total_1{
        margin: 10px 0 0 30px;
    }
    @media (max-width: 468px) {
        .item01 input{
            font-size: 15px;
            height: 30px;
            width: 60%;
        }
        .message{
            font-size: 15px;
            padding: 0 20px;
        }
    }
    </style>

    <h1 style="text-align: center; padding-top: 80px;">Корзина</h1>

    <!-- Продукты из Market -->
    <form method="POST" action="{% url 'ru_buyurtma_berish' %}">
        {% csrf_token %}

        {% for market in market_sklad %}
            {% if market.group_lang == 'ru' %}
                <div class="item">
                    <div class="blog_teg">
                        {% if market.photo.url %}
                        <div>
                            <img class="imgcha" src="{{ market.photo.url }}" alt="img">
                        </div>
                        {% endif %}
                    </div>
                    <div class="item01">
                        <h1 class="h101">{{ market.title }}</h1>
                        <h1 style="margin-bottom: 15px;" class="h102">Цена: <span class="price" id="price_2M">{{ market.body }}</span> сум</h1>
                        <label for="son_{{ aborud.id }}" style="color: #004b23;">Количество: 1</label>
                        <a href="{% url 'ru_market_savatdan_ochir' market.id %}">
                            <img class="img_minus" src="../../media/images/minus-sign-icon-free-png.webp" alt="minus" style="width: 31px ; height: 31px; border: none; margin-left: 5px; margin-top:2px;
                            ">
                        </a>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
        <!-- Продукты из Aborud -->
        {% for aborud in aborud_sklad %}
            {% if aborud.group_lang == 'ru' %}
                <div class="item">
                    <div class="blog_teg">
                        {% if aborud.photo.url %}
                        <div>
                            <img class="imgcha" src="{{ aborud.photo.url }}" alt="img">
                        </div>
                        {% endif %}
                    </div>
                    <div class="item01">
                        <h1 class="h101">{{ aborud.title }}</h1>
                        <h1 style="margin-bottom: 15px;" class="h102">Цена: <span class="price" id="price_2A">{{ aborud.body }}</span> сум</h1>
                        <label for="son_{{ aborud.id }}" style="color: #004b23;">Количество: 1</label>
                        <a href="{% url 'ru_aborud_savatdan_ochir' aborud.id %}">
                            <img class="img_minus" src="../media/images/minus-sign-icon-free-png.webp" alt="minus" style="width: 31px ; height: 31px; border: none; margin-left: 5px; margin-top:2px;
                            ">
                        </a>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
        <!-- Продукты из Seryo -->
        {% for seryo in seryo_sklad %}
            {% if seryo.group_lang == 'ru' %}
                <div class="item">
                    <div class="blog_teg">
                        {% if seryo.photo.url %}
                        <div>
                            <img class="imgcha" src="{{ seryo.photo.url }}" alt="img">
                        </div>
                        {% endif %}
                    </div>
                    <div class="item01">
                        <h1 class="h101">{{ seryo.title }}</h1>
                        <h1 class="h102">Цена: <span class="price" id="price_1">{{ seryo.body }}</span> сум</h1>
                        <label for="kg_{{ seryo.id }}" style="color: #004b23;">КГ:</label>
                        <input
                            id="kg_1"
                            type="number"
                            name="kg_{{ seryo.id }}"
                            min="10"
                            step="1"
                            value="10"
                            oninput="updateTotal({{ seryo.id }}, {{ seryo.body }})"
                            onchange="updateTotal(1)"
                            autocomplete="on"
                            >                
                        <p id="total_1">Общая сумма: 0 сум</p>
                    
                        <a href="{% url 'ru_seryo_savatdan_ochir' seryo.id %}">
                            <img class="img_minus" src="../../media/images/minus-sign-icon-free-png.webp" alt="minus" style="width: 31px ; height: 31px; border: none; margin-left: 5px; margin-top:2px;
                            ">
                        </a>
                    </div>
                </div>
            {% endif %}
        {% endfor %}

        <!-- Продукты из Mahsulot -->
        {% for mahsulot in mahsulot_sklad %}
            {% if mahsulot.group_lang == 'ru' %}
                <div class="item">
                    <div class="blog_teg">
                        {% if mahsulot.photo.url %}
                        <div>
                            <img class="imgcha" src="{{ mahsulot.photo.url }}" alt="img">
                        </div>
                        {% endif %}
                    </div>
                    <div class="item01">
                        <h1 class="h101">{{ mahsulot.title }}</h1>
                        <h1 class="h102">Цена: <span class="price" id="price_2" >{{ mahsulot.body }}</span> сум</h1>
                        <label for="kg_{{ mahsulot.id }}" style="color: #004b23;">КГ:</label>                
                        <input
                            id="kg_2"
                            type="number"
                            name="kg_{{ mahsulot.id }}"
                            min="10"
                            step="1"
                            value="10"
                            onchange="updateTotal(2), hisobla()"
                            autocomplete="on"
                            >                
                        <p id="total_2">Общая сумма: 0 сум</p>
                        <a href="{% url 'ru_mahsulot_savatdan_ochir' mahsulot.id %}">
                            <img class="img_minus" src="../../media/images/minus-sign-icon-free-png.webp" alt="minus" style="width: 31px ; height: 31px; border: none; margin-left: 5px; margin-top:2px;
                            ">
                        </a>
                    </div>
                </div>
            {% endif %}
        {% endfor %}
        <p id="umumiy_narx" style="text-align: center; margin-top: 20px; font-size: 20px;">Общая стоимость: 0 сум</p>

        {% if user.is_authenticated %}
        <button type="submit" class="btn btn-success sklad">Разместить заказ</button>
        {% else %}
        <p class="message" style="color: red; text-align: center; font-weight: bold; margin-top: 10px;">Для заказа сначала авторизуйтесь</p>
        <a href="{% url 'ru_login' %}" style="text-align: center; display: block;" class="btn btn-success sklad">Перейти на страницу входа</a>
        {% endif %}
    </form>

        {% for message in messages %}
            <p class="message" style="color: red; text-align: center; font-weight: bold; margin-bottom: 10px;">{{ message }}</p>
        {% endfor %}
        <script>
            function updateTotal(productId) {
                const priceElement = document.getElementById(`price_${productId}`);
                const kgInput = document.getElementById(`kg_${productId}`);
                const totalElement = document.getElementById(`total_${productId}`);
                const umumiyNarxElement = document.getElementById('umumiy_narx');
        
                // Narxni olish
                if (!priceElement) return; // Agar narx elementi mavjud bo‘lmasa, hisoblamaslik
        
                const pricePerKg = parseFloat(priceElement.innerText.replace(',', '').replace('.', '')) || 0;
                let kg = kgInput ? parseFloat(kgInput.value) || 0 : 1; // Agar kilogramm elementi bo'lmasa, 1 deb qabul qilamiz
        
                // Minimal kilogramm tekshiruvi
                if (kgInput && kg < 10) {
                    alert("Minimal kilogramm miqdori 10 kg bo'lishi kerak!");
                    kg = 10;
                    kgInput.value = 10;
                }
        
                // Har bir mahsulotning jami narxini hisoblash
                const total = kg * pricePerKg;
                if (totalElement) {
                    totalElement.innerText = `Jami summa: ${total.toLocaleString()} so'm`;
                }
        
                // Umumiy narxni hisoblash
                let umumiyNarx = 0;
        
                // 1. Barcha `market` va `aborud` narxlarini qo‘shish
                const marketPrices = document.querySelectorAll('#price_2M, #price_2A'); // `market` va `aborud` narxlari
                marketPrices.forEach(price => {
                    umumiyNarx += parseFloat(price.innerText.replace(',', '').replace('.', '')) || 0;
                });
        
                // 2. Barcha `Jami summa` elementlarini yig‘ish (seryo va mahsulotlar uchun)
                document.querySelectorAll('[id^="total_"]').forEach((element) => {
                    const value = parseFloat(element.innerText.replace('Jami summa: ', '').replace(/[^0-9.-]+/g, '')) || 0;
                    umumiyNarx += value;
                });
        
                // Umumiy narxni yangilash
                umumiyNarxElement.innerText = `Umumiy narx: ${umumiyNarx.toLocaleString()} so'm`;
            }
        
            // DOM to‘liq yuklanganda hisoblash
            document.addEventListener('DOMContentLoaded', function () {
                // Barcha mahsulotlar uchun hisoblash
                document.querySelectorAll('[id^="kg_"]').forEach(input => {
                    const productId = input.id.split('_')[1]; // IDdan mahsulot raqamini olish
                    updateTotal(productId); // Hisoblash
                });
        
                // Faqat `market` va `aborud` narxlarini qo‘shish
                const umumiyNarxElement = document.getElementById('umumiy_narx');
                let umumiyNarx = 0;
                const marketPrices = document.querySelectorAll('#price_2M, #price_2A');
                marketPrices.forEach(price => {
                    umumiyNarx += parseFloat(price.innerText.replace(',', '').replace('.', '')) || 0;
                });
        
                umumiyNarxElement.innerText = `Umumiy narx: ${umumiyNarx.toLocaleString()} so'm`;
            });
        
                // + tugmasi
            function increase(productId) {
                const kgInput = document.getElementById(`kg_${productId}`);
                kgInput.value = parseInt(kgInput.value) + 1;
                updateTotal(productId);
            }
        
            function decrease(productId) {
                const kgInput = document.getElementById(`kg_${productId}`);
                if (parseInt(kgInput.value) > 10) {
                    kgInput.value = parseInt(kgInput.value) - 1;
                    updateTotal(productId);
                } else {
                    alert("Minimal kilogramm miqdori 10 kg bo'lishi kerak!");
                }
            }
        
        
            // Input qiymati o'zgartirilganida hisoblash
            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('input', function () {
                        const productId = this.id.split('_')[1];
                        updateTotal(productId);
                    });
                });
            });
        
        
        
        
        
        
        
            // DOM to‘liq yuklanganda hisoblash
            document.addEventListener('DOMContentLoaded', function () {
                hisobla(); // Defolt holatda hisoblash
            });
        
            // Input qiymati o'zgartirilganida hisoblash
            document.querySelectorAll('.kg-input').forEach((input) => {
                input.addEventListener('input', hisobla); // Har bir input uchun
            });
            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('.item a').forEach(button => {
                    button.addEventListener('click', function (event) {
                        event.preventDefault();
                        const url = this.getAttribute('href');
                        fetch(url, { method: 'GET' })
                            .then(response => {
                                if (response.ok) {
                                    alert("Mahsulot savatdan o'chirildi!");
                                    this.closest('.item').remove(); // Mahsulotni UI-dan olib tashlash
                                } else {
                                    alert("Xatolik yuz berdi!");
                                }
                            })
                            .catch(error => console.error('Xatolik:', error));
                    });
                });
            });
        
            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('input[type="number"]').forEach(input => {
                    input.addEventListener('change', function () {
                        if (this.value < 10) {
                            alert("Minimal kilogramm 10 kg bo'lishi kerak!");
                            this.value = 10;  // Minimal qiymatni qayta tiklash
                        }
                    });
                });
            });
        </script>
{% endblock content %}
